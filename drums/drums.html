<!DOCTYPE html>
<html>
  <head>
    <title>drums</title>
    <script src="play.js"></script>
    <script src="song.js"></script>
    <script src="timeline.js"></script>
    <script>

var context = new webkitAudioContext();
var master_verb = null;
var master_verb_gain = null;
var master_dry_gain = null;
var master_comp = null;
var fx_channel = [];
var fx_adjust_function = {};

var sound_source = null;
var buffer = null;

var sounds = {};
var kit = null;
var song = null;

function loadfn(buffer, url, error_info) {
  if (buffer) {
    sounds[url] = buffer;
  }
}

function loadkit(instrument_list) {
  var kit = [];
  for (i in instrument_list) {
    var info_in = instrument_list[i];
    for (layer in info_in) {
      for (volume in info_in[layer]) {
	load_sample(info_in[layer][volume], loadfn);
      }
    }
    kit.push(info_in);
  }
  return kit;
}

function init() {
  buffer = context.createBuffer(2, 10000, 44100);

  // Test tone.
  sound_source = context.createBufferSource();
  sound_source.buffer = buffer;
  sound_source.connect(context.destination);
  var data = buffer.getChannelData(0);
  for (var i = 0; i < data.length; i++) {
    data[i] = Math.sin(i / data.length * 1000);
  }
  var data = buffer.getChannelData(1);
  for (var i = 0; i < data.length; i++) {
    data[i] = Math.sin(i / data.length * 1000 + 0.1);
  }
  sound_source.start(0);

  // Master fx etc.
  master_verb = context.createConvolver();
  master_verb_gain = context.createGain();
  master_comp = context.createDynamicsCompressor();
  master_dry_gain = context.createGain();

  master_comp.connect(context.destination);
  master_dry_gain.connect(master_comp);
  master_verb.connect(master_verb_gain);
  master_verb_gain.connect(master_comp);

  // http://www.openairlib.net/auralizationdb/content/stairway-university-york
  // http://www.openairlib.net/auralizationdb/content/maes-howe
  // http://www.openairlib.net/auralizationdb/content/terrys-typing-room
  // http://www.openairlib.net/auralizationdb/content/lady-chapel-st-albans-cathedral
  // cc-by-sa
//  load_sample(
//      //"samples/stairwell_ortf.wav",   // tight
//      //"samples/mh3_000_ortf_48k.wav",  // nice small room (vocal?)
//      //"samples/terrys_typing_ortf.wav",  // big, slap-back
//      "samples/lyd3_000_ortf_48k.wav",  //
//      //"samples/stalbans_a_binaural.wav",  // boomy, but boxy
//      function(buffer) {
//	master_verb.buffer = buffer;
//      });

  // http://www.echochamber.ch/index.php/tipps-a-freebies/impulseresponses
  // http://www.echochamber.ch/images/responses/quantec/quantec_1.ZIP
  load_sample(
      "samples/reverb/quantec_1/concert_h+a.wav",
      function(buffer) {
	master_verb.buffer = buffer;
      });

  master_verb_gain.gain.value = 0.30;
  master_dry_gain.gain.value = 2.0;

  master_comp.attack.value = 0.003;
  master_comp.knee.value = 30;
  master_comp.ratio.value = 4;
  master_comp.reduction.value = -0.000123;
  master_comp.release.value = 0.050;
  master_comp.threshold.value = -10;

  // fx channels
  var flat = context.createBuffer(2, 1, 44100);
  flat.getChannelData(0)[0] = 1;
  flat.getChannelData(1)[0] = 1;
  for (var i = 0; i < 9; i++) {
    var fx = {
      "eqhi": context.createBiquadFilter(),
      "eqmid": context.createBiquadFilter(),
      "eqlo": context.createBiquadFilter(),
      "comp": context.createDynamicsCompressor(),
      "rev": context.createConvolver(),
      "gain": context.createGain()
    };
    fx.eqhi.connect(fx.eqmid);
    fx.eqmid.connect(fx.eqlo);
    fx.eqlo.connect(fx.comp);
    fx.comp.connect(fx.rev);
    fx.rev.connect(fx.gain);
    fx.gain.connect(master_verb);
    fx.gain.connect(master_dry_gain);

    fx.eqhi.type = "highshelf";
    fx.eqhi.frequency.value = 12000;
    fx.eqhi.gain.value = 0;
    fx.eqmid.type = "peaking";
    fx.eqmid.frequency.value = 2000;
    fx.eqmid.Q.value = 1.0;
    fx.eqmid.gain.value = 0;
    fx.eqlo.type = "lowshelf";
    fx.eqlo.frequency.value = 100;
    fx.eqlo.gain.value = 0;
    fx.comp.threshold.value = -10;
    fx.comp.ratio.value = 1;
    fx.comp.knee.value = 0;
    fx.rev.normalize = false;  // The f'ing normalization formula for convolver is bugged? sigh
    fx.rev.buffer = flat;

    fx_channel.push(fx);
  }

  kit1 = loadkit([
      [["bender_stick.wav"]],
      [["builttospill_kick.wav"]],
      [["builttospill_ride.wav"]],
      [["gobo_hat.wav"]],
      [["gobo_hat2.wav"]],
      [["gobo_snare.wav"]],
      [["smokingpopes_kick.wav"]],
      [["spoon_hi_tom.wav"]],
      [["spoon_lo_tom.wav"]],
      [["spoon_snare.wav"]],
      [["stevenson_snare.wav"]],]
          );


  // http://rhythminmind.net/STN/?page_id=14
  kit = loadkit([
    [["samples/kick 1 outside - 22in pearl master custom.wav",
      "samples/kick 2 outside - 22in pearl master custom.wav",
      "samples/kick 3 outside - 22in pearl master custom.wav",
      "samples/kick 4 outside - 22in pearl master custom.wav",
      "samples/kick 5 outside - 22in pearl master custom.wav",
      "samples/kick 6 outside - 22in pearl master custom.wav"]
    ],
    [["samples/snare combined 1 - 14in pearl master custom.wav",
      "samples/snare combined 2 - 14in pearl master custom.wav",
      "samples/snare combined 3 - 14in pearl master custom.wav",
      "samples/snare combined 4 - 14in pearl master custom.wav",
      "samples/snare combined 5 - 14in pearl master custom.wav",
      "samples/snare combined 6 - 14in pearl master custom.wav",
     ]
    ],
    [["samples/hat foot 1 - 13in zildjian remix.wav"],
     ["samples/hat foot 2 - 13in zildjian remix.wav"],
     ["samples/hat foot 3 - 13in zildjian remix.wav"],
    ],
    [["samples/hat tight 1 - 13in zildjian remix.wav"],
     ["samples/hat tight 2 - 13in zildjian remix.wav"],
     ["samples/hat tight 3 - 13in zildjian remix.wav"],
     ["samples/hat tight 4 - 13in zildjian remix.wav"],
     ["samples/hat tight 5 - 13in zildjian remix.wav"],
     ["samples/hat tight 6 - 13in zildjian remix.wav"],
    ],
    [["samples/hat loose 1 - 13in zildjian remix.wav"],
     ["samples/hat loose 2 - 13in zildjian remix.wav"],
     ["samples/hat loose 3 - 13in zildjian remix.wav"],
     ["samples/hat loose 4 - 13in zildjian remix.wav"],
     ["samples/hat loose 5 - 13in zildjian remix.wav"],
     ["samples/hat loose 6 - 13in zildjian remix.wav"],
    ],
    [["samples/hat open 1 - 13in zildjian remix.wav"],
     ["samples/hat open 2 - 13in zildjian remix.wav"],
     ["samples/hat open 3 - 13in zildjian remix.wav"],
     ["samples/hat open 4 - 13in zildjian remix.wav"],
    ],
    [["samples/ride 1 - 18in zildjian.wav"],
     ["samples/ride 2 - 18in zildjian.wav"],
     ["samples/ride 3 - 18in zildjian.wav"],
     ["samples/ride 4 - 18in zildjian.wav"],
     ["samples/ride 5 - 18in zildjian.wav"],
     ["samples/ride 6 - 18in zildjian.wav"],
    ],
    //[["samples/small crash 6 - 16in zildjian.wav"]],
    [["samples/small tom 1 - 10in pearl master custom.wav"],
     ["samples/small tom 2 - 10in pearl master custom.wav"],
     ["samples/small tom 3 - 10in pearl master custom.wav"],
     ["samples/small tom 4 - 10in pearl master custom.wav"],
     ["samples/small tom 5 - 10in pearl master custom.wav"],
     ["samples/small tom 6 - 10in pearl master custom.wav"],
    ],
    [["samples/med tom 1 - 12in pearl master custom.wav"],
     ["samples/med tom 2 - 12in pearl master custom.wav"],
     ["samples/med tom 3 - 12in pearl master custom.wav"],
     ["samples/med tom 4 - 12in pearl master custom.wav"],
     ["samples/med tom 5 - 12in pearl master custom.wav"],
     ["samples/med tom 6 - 12in pearl master custom.wav"],
    ],
    [["samples/floor tom 1 - 14in pearl master custom.wav"],
     ["samples/floor tom 2 - 14in pearl master custom.wav"],
     ["samples/floor tom 3 - 14in pearl master custom.wav"],
     ["samples/floor tom 4 - 14in pearl master custom.wav"],
     ["samples/floor tom 5 - 14in pearl master custom.wav"],
     ["samples/floor tom 6 - 14in pearl master custom.wav"],
    ],
                  ]);

  song = create_test_song();//xxxx

  init_kit_fx_ui();
}

function keydown(ev) {
  console.log(ev.keyCode);
  if (ev.keyCode >= 48 && ev.keyCode <= 57) {  // '0' - '9'
    play(ev.keyCode - 48, 255.0, 0.010);
  } else if (ev.keyCode == 32) {  // space
    queue_song(song);
  } else if (ev.keyCode == 38) {  // up
    nav_up();
  } else if (ev.keyCode == 40) {  // down
    nav_down();
  } else if (ev.keyCode == 37) {  // left
    nav_left();
  } else if (ev.keyCode == 39) {  // right
    nav_right();
  } else if (ev.keyCode == 189) {  // -
    do_increment(-1);
  } else if (ev.keyCode == 187) {  // +
    do_increment(1);
  }

  // 189 == '-'
  // 187 == '=' (+)

  // 16 == shift
  // 17 == ctrl
  // 18 == alt
}

function keyup(ev) {
}

function handle_unanchored() {
  if (document.activeElement == document.body ||
      document.activeElement.getAttribute("class") != "knob32anchor") {
    document.getElementById("fx0eqhi").previousSibling.focus();
    return true;
  }
  return false;
}

function nav_up() {
  if (handle_unanchored()) { return; }
  var elem = document.activeElement;
  var prev = elem.parentNode.parentNode.previousSibling;
  if (!prev || prev.getAttribute("class") != "control") {
    // TODO wrap
    return;
  }
  prev.firstChild.firstChild.focus();
}

function nav_down() {
  if (handle_unanchored()) { return; }
  var elem = document.activeElement;
  var next = elem.parentNode.parentNode.nextSibling;
  if (!next || next.getAttribute("class") != "control") {
    // TODO wrap
    return;
  }
  next.firstChild.firstChild.focus();
}

function nav_left() {
  if (handle_unanchored()) { return; }
  var elem = document.activeElement;
  var id = elem.nextSibling.getAttribute("id");
  var channel = Number(id.substr(2, 1)) - 1;
  if (channel < 0) channel = 8;
  var next_id = id.substr(0, 2) + String(channel) + id.substr(3);
  document.getElementById(next_id).previousSibling.focus();
}

function nav_right() {
  if (handle_unanchored()) { return; }
  var elem = document.activeElement;
  var id = elem.nextSibling.getAttribute("id");
  var channel = Number(id.substr(2, 1)) + 1;
  if (channel > 8) channel = 0;
  var next_id = id.substr(0, 2) + String(channel) + id.substr(3);
  document.getElementById(next_id).previousSibling.focus();
}

function do_increment(ticks) {
  var elem = document.activeElement;
  var id = elem.nextSibling.getAttribute("id");
  var adjust_fn = fx_adjust_function[id];
  if (adjust_fn) {
    adjust_fn(ticks);
  }
}

var fx_channel_assignments = [
  [0, 8],  // kick
  [1, 8],  // snare
  [2, 8],  // hat foot
  [2, 8],  // hat tight
  [2, 8],  // hat loose
  [2, 8],  // hat open
  [3, 8],  // ride
  [4, 8],  // hitom
  [5, 8],  // midtom
  [6, 8],  // lotom
  // TODO crashes etc
];

function play(instrument, volume, time_offset) {
  var inst = kit[instrument];
  for (layer in inst) {
    var nl = inst[layer].length;
    var index = Math.floor(volume / 256.0 * nl);
    var url = inst[layer][index];
    var vol1 = Math.floor((index + 1) / nl * 255.0);
    var v = 255.0 * volume / vol1;
    rawplay(url, v, time_offset, fx_channel_assignments[instrument]);
  }
}

function rawplay(url, volume, time_offset, channels) {
  if (url in sounds) {
    var src = context.createBufferSource();
    src.buffer = sounds[url];
    var gain = context.createGain();
    gain.gain.value = volume / 255.0;
    //gain.connect(master_dry_gain);
    //gain.connect(master_verb);
    for (i in channels) {
      gain.connect(fx_channel[channels[i]].eqhi);  // xxx out
    }
    src.connect(gain);

    if (time_offset == undefined) {
      time_offset = 0.010;
    }
    src.start(context.currentTime + time_offset);
  }
}

function load_sample(url, continuation) {
  var request = new XMLHttpRequest();
  request.open("GET", url, true);
  request.responseType = "arraybuffer";

  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
        continuation(buffer, url, null);
      },
      function() {
        console.log("error loading", url);
      }
      );
  };
  request.onerror = function() {
    console.log("XHR loading error", url);
    continuation(null, url, "error");
  };
  request.send();
}

// kit ui

var knob_image_url;

function init_kit_fx_ui() {
  // Make a knob.
  var canvas = document.createElement('canvas');
  canvas.setAttribute("width", "32");
  canvas.setAttribute("height", "32");
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, 32, 32);
  ctx.fillStyle = "#ddd";
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2.0;
  ctx.beginPath();
  ctx.arc(16.5, 16.5, 14, 0, Math.PI * 2);
  ctx.fill();
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(16.5, 16.5 - 8);
  ctx.lineTo(16.5, 2);
  ctx.stroke();
  knob_image_url = canvas.toDataURL();

  var styles = document.getElementById("styles").sheet;
  var rule = "position: absolute; top: 0; height: 32px; left: 0; width: 32px; background-image: url(" + knob_image_url + ");";
  styles.addRule(".knob32", rule);

  var channel_names = [ "kick", "snare", "hat", "ride",
			"htom", "mtom", "ltom",
			"OH", "room"
			 ];
  for (var i in channel_names) {
    document.getElementById("fx" + i).appendChild(make_channel_fx_ui(i, channel_names[i]));
  }
  for (var control in fx_adjust_function) {
    fx_adjust_function[control](0);
  }
}

function make_channel_fx_ui(i, label) {
  var outer = document.createElement("div");
  outer.style.width = "34px";
  outer.innerHTML = label + "<br/>";
  outer.appendChild(make_control_widget(i, 'eqhi', fx_channel[i].eqhi.gain, -20, 20, 0));
  outer.appendChild(make_control_widget(i, 'eqmd', fx_channel[i].eqmid.gain, -20, 20, 0));
  outer.appendChild(make_control_widget(i, 'eqsw', fx_channel[i].eqmid.frequency, 200, 8000, 2000, 64));
  outer.appendChild(make_control_widget(i, 'eqlo', fx_channel[i].eqlo.gain, -20, 20, 0));

  outer.appendChild(make_control_widget(i, 'c_thr', fx_channel[i].comp.threshold, -100, 0, -24));
  outer.appendChild(make_control_widget(i, 'c_rat', fx_channel[i].comp.ratio, 1, 20, 1));
  outer.appendChild(make_control_widget(i, 'c_att', fx_channel[i].comp.attack, 0, 1, 0.003));
  outer.appendChild(make_control_widget(i, 'c_rel', fx_channel[i].comp.release, 0, 1, 0.25));

  //outer.appendChild(make_control_widget(i, '_8', fx_channel[i].rev...));//xxxx TODO reverb

  outer.appendChild(make_control_widget(i, 'gain', fx_channel[i].gain.gain, 0, 2, 1));

  return outer;
}

function make_control_widget(i, label, variable, lo, hi, def, increments) {
  var d = document.createElement("div");
  d.setAttribute("class", "control");
  var id = "fx" + i + label;
  d.innerHTML = "<div style='height: 32px; display: table-cell; vertical-align: " +
      "middle; text-align: center;'><a href='javascript:void(0);' class='knob32anchor'> </a>" +
      "<div class='knob32' id='" + id +
	  "' style='height: 32px;'></div><p class='knoblabel'>" + label + "</p></div>";

  var default_tick = Math.round((def - lo) / (hi - lo) * 16.0);
  if (increments == undefined) {
    increments = 32;
  }

  // hookup gauge 'fx0eqhi' to the variable.value
  var adjust = function(increment) {
    var current = Math.round((variable.value - lo) / (hi - lo) * increments);
    var next_tick = Math.max(0, Math.min(current + increment, increments));
    var next_value = (next_tick / increments) * (hi - lo) + lo;
    console.log(next_value);//xxxxxxx
    variable.value = next_value;

    var rotation = "rotate(" + Math.round((next_tick - increments / 2) * (288.0 / increments)) + "deg)";
    var elem = document.getElementById(id);
    elem.style['-webkit-transform'] = rotation;
    elem.style['-moz-transform'] = rotation;
    elem.style['transform'] = rotation;

    // maybe adjust the color if the setting is off the default.

    return next_tick;
  }

  fx_adjust_function[id] = adjust;

  return d;
}


window.onload = init;
window.onkeydown = keydown;
window.onkeyup = keyup;

    </script>
    <style type="text/css" id="styles">
      .control {
        //margin-left: auto;
        //margin-right: 0px;
        //float: right;
        position: relative;
        width: 34px;
        height: 38px;
      }
      .gauge32 {
        position: absolute;
        top: 0;
        height: 32px;
        left: 0;
        width: 32px;
        background-size: 8px 32px;
        background-position: bottom;
        background-image: linear-gradient(to top, blue, cyan, green, yellow, red);
      }
      .knoblabel {
        width: 32px;
        position: relative;
        font-size: 10px;
        font-family: sans-serif;
        text-align: center;
        margin-left: auto;
        margin-right: auto;
      }
      .knob32anchor {
	position: absolute;
        width: 32px;
	height: 32px;
      }
      .knob32anchor:focus {
	background-color:yellow;
      }
    </style>
  </head>
  <body>

    <div id="timeline" style="height: 200px">
    </div>

    <table id="kitparams" style="height: 400px;">
      <tr>
        <td id="fx0">
        </td><td id="fx1">
        </td><td id="fx2">
        </td><td id="fx3">
        </td><td id="fx4">
        </td><td id="fx5">
        </td><td id="fx6">
        </td><td id="fx7">
        </td><td id="fx8">
	</td>
      </tr>
    </table>
  </body>
</html>
