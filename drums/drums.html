<!DOCTYPE html>
<html>
  <head>
    <script src="timeline.js"></script>
    <script>

var context = new webkitAudioContext();

var sound_source = null;
var buffer = null;

var sounds = {};
var voices = [];
var kit = null;

function loadfn(buffer, url, error_info) {
  if (buffer) {
    sounds[url] = buffer;
  }
}

function loadkit(urls) {
  var kit = [];
  for (u in urls) {
    load_sample(urls[u], loadfn);
    kit.push(urls[u]);
  }
  return kit;
}

function init() {
  buffer = context.createBuffer(1, 10000, 44100);
  sound_source = context.createBufferSource();
  sound_source.buffer = buffer;
  sound_source.connect(context.destination);

  var data = buffer.getChannelData(0);
  for (var i = 0; i < data.length; i++) {
    data[i] = Math.sin(i / data.length * 1000);
  }

  var source2 = context.createBufferSource();
  source2.buffer = buffer;
  source2.connect(context.destination);

  sound_source.start(0);
  source2.start(0.20);

  // Create voices.
  for (var i = 0; i < 32; i++) {
    var v = context.createBufferSource();
    v.connect(context.destination);
    voices.push(v);
  }

  kit1 = loadkit([
      "bender_stick.wav",
      "builttospill_kick.wav",
      "builttospill_ride.wav",
      "gobo_hat.wav",
      "gobo_hat2.wav",
      "gobo_snare.wav",
      "smokingpopes_kick.wav",
      "spoon_hi_tom.wav",
      "spoon_lo_tom.wav",
      "spoon_snare.wav",
      "stevenson_snare.wav",]
          );


  // http://rhythminmind.net/STN/?page_id=14
  kit = loadkit([
      "samples/floor tom 6 - 14in pearl master custom.wav",
      "samples/kick 6 outside - 22in pearl master custom.wav",
      "samples/snare top 6 - 14in pearl master custom.wav",
      "samples/snare bottom 6 - 14in pearl master custom.wav",
      "samples/hat tight 6 - 13in zildjian remix.wav",
      "samples/hat open 4 - 13in zildjian remix.wav",
      "samples/ride 6 - 18in zildjian.wav",
      "samples/small crash 6 - 16in zildjian.wav",
      "samples/small tom 6 - 10in pearl master custom.wav",
      "samples/med tom 6 - 12in pearl master custom.wav",
                  ]);
}

function keydown(ev) {
  console.log(ev.keyCode);
  if (ev.keyCode >= 48 && ev.keyCode <= 57) {  // '0' - '9'
    play(kit[ev.keyCode - 48]);
  }
}

function keyup(ev) {
}

function play(url) {
  if (url in sounds) {
    var src = context.createBufferSource();
    src.buffer = sounds[url];
    src.connect(context.destination);
    src.start(0);
  }
}

function load_sample(url, continuation) {
  var request = new XMLHttpRequest();
  request.open("GET", url, true);
  request.responseType = "arraybuffer";

  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
        continuation(buffer, url, null);
      },
      function() {
        console.log("error loading", url);
      }
      );
  };
  request.onerror = function() {
    console.log("XHR loading error", url);
    continuation(null, url, "error");
  };
  request.send();
}

window.onload = init;
window.onkeydown = keydown;
window.onkeyup = keyup;

    </script>
  </head>
  <body>
  </body>
</html>
